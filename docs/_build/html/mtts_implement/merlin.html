

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.7 Merlin简要使用手册 &mdash; MTTS  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="MTTS  documentation" href="../index.html"/>
        <link rel="up" title="第三章 中文语音合成系统的实现" href="index.html"/>
        <link rel="next" title="3.8 声码器" href="vocoder.html"/>
        <link rel="prev" title="3.6 HMM训练" href="hmm_training.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> MTTS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">语音合成新手指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../recent_advances.html">最新研究进展</a></li>
<li class="toctree-l1"><a class="reference internal" href="../literature_review.html">第一章 文献综述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mtts_theory/index.html">第二章 语音合成理论研究</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">第三章 中文语音合成系统的实现</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="corpus.html">3.1 语料库</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_analyse.html">3.2 文本分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="prosody_processing.html">3.4 韵律处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="audio_processing.html">3.5 语音学处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="hmm_training.html">3.6 HMM训练</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.7 Merlin简要使用手册</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">3.7.1 Merlin的安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.7.2 Merlin源码理解</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">0 文件含义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1 免费的语料库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">2 训练数据的处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#demo">3 Demo语料库的训练</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">4 Demo语料库的合成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">5.Merlin的训练网络</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">3.7.3 Merlin 前端</a></li>
<li class="toctree-l3"><a class="reference internal" href="#merlin-vocoder">3.7.4 Merlin vocoder声码器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#merlinlabel">3.7.5 生成Merlin的英文label用于语音合成</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vocoder.html">3.8 声码器</a></li>
<li class="toctree-l2"><a class="reference internal" href="speech_synthesis.html">3.9 语音合成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../voice_evaluation/index.html">第四章 合成语音质量的评估</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/index.html">附录</a></li>
<li class="toctree-l1"><a class="reference internal" href="../toolkit.html">语音合成相关工具包</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">参考文献和资料</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MTTS</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">第三章 中文语音合成系统的实现</a> &raquo;</li>
        
      <li>3.7 Merlin简要使用手册</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/mtts_implement/merlin.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="merlin">
<h1>3.7 Merlin简要使用手册<a class="headerlink" href="#merlin" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>3.7.1 Merlin的安装<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p><strong>安装</strong></p>
<p>Merlin只能在unix类系统下运行，使用Python，并用theano作为后端</p>
<p>Merlin的Python语言采用的是Python2.7编写，所以我们需要在Python2.7的环境下运行Merlin，为避免python不同版本之间的冲突，我们采用Anaconda对Python运行环境进行管理。</p>
<p>使用Anaconda创建Merlin运行环境具体操作如下：</p>
<p>打开终端，使用下面命令查看一下现有python环境</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">env</span> <span class="nb">list</span>
</pre></div>
</div>
<p>使用下面命令创建一个名为merlin的python环境</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">--</span><span class="n">name</span> <span class="n">merlin</span> <span class="n">python</span><span class="o">=</span><span class="mf">2.7</span>
</pre></div>
</div>
<p>先进入merlin环境中</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">activate</span> <span class="n">merlin</span>
</pre></div>
</div>
<p>在这个环境下安装merlin</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">csh</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">numpy</span> <span class="n">scipy</span> <span class="n">matplotlib</span> <span class="n">lxml</span> <span class="n">theano</span> <span class="n">bandmat</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">CSTR</span><span class="o">-</span><span class="n">Edinburgh</span><span class="o">/</span><span class="n">merlin</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">merlin</span><span class="o">/</span><span class="n">tools</span>
<span class="o">./</span><span class="n">compile_tools</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>如果一切顺利，此时你已经成功地安装了Merlin，但要注意的是Merlin不是一个完整的TTS系统。它提供了核心的声学建模功能：语言特征矢量化，声学和语言特征归一化，神经网络声学模型训练和生成。但语音合成的前端（文本处理器）以及声码器需要另外配置安装。此外，Merlin目前仅提供了英文的语音合成。</p>
<p>此外，上述安装默认只配置支持CPU的theano，如果想要用GPU加速神经网络的训练，还需要进行其他的步骤。由于语料库的训练时间尚在笔者的接受范围之内（intel-i5，训练slt_arctic_full data需要大概6个小时），因此这里并没有使用GPU进行加速训练。</p>
<p><strong>运行Merlin demo</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>sudo bash ～/merlin/egs/slt_arctic/s1/run_demo.sh
</pre></div>
</div>
<p>该脚本会使用50个音频样本进行声学模型和durarion模型的训练，并合成5个示例音频。在此略去详细的操作步骤，具体可参见：Getting started with the Merlin Speech Synthesis Toolkit <a class="reference external" href="https://jrmeyer.github.io/merlin/2017/02/14/Installing-Merlin.html">installing-Merlin</a></p>
</div>
<div class="section" id="id2">
<h2>3.7.2 Merlin源码理解<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>0 文件含义<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="93%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Folder</th>
<th class="head">Contains</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>recordings</td>
<td>speech recordings, copied from the studio</td>
</tr>
<tr class="row-odd"><td>wav</td>
<td>individual wav files for each utterance</td>
</tr>
<tr class="row-even"><td>pm</td>
<td>pitch marks</td>
</tr>
<tr class="row-odd"><td>mfcc</td>
<td>MFCCs for use in automatic alignment <a class="reference external" href="http://practicalcryptography.com/miscellaneous/machine-learning/guide-mel-frequency-cepstral-coefficients-mfccs/">mfcc tutorial</a></td>
</tr>
<tr class="row-even"><td>lab</td>
<td>label files from automatic alignment</td>
</tr>
<tr class="row-odd"><td>utt</td>
<td>Festival utterance structures</td>
</tr>
<tr class="row-even"><td>f0</td>
<td>Pitch contours</td>
</tr>
<tr class="row-odd"><td>coef</td>
<td>MFCCs + f0, for the join cost</td>
</tr>
<tr class="row-even"><td>coef2</td>
<td>coef2, but stripped of unnecessary frames to save space, for the join cost</td>
</tr>
<tr class="row-odd"><td>lpc</td>
<td>LPCs and residuals, for waveform generation</td>
</tr>
<tr class="row-even"><td>bap</td>
<td>band aperiodicity</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h3>1 免费的语料库<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Merlin使用了网络上免费的语料库slt_arctic，可以在以下网址进行下载：<a class="reference external" href="http://104.131.174.95/slt_arctic_full_data.zip">slt_arctic_full_data.zip</a></p>
</div>
<div class="section" id="id5">
<h3>2 训练数据的处理<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Merlin自带的demo（merlin/egs/slt_arctic/s1 ）已经事先完成了label文件的提取，所以这里不需要前端FrontEnd对数据进行处理。</p>
<p>Merlin通过脚本文件setup.sh在～/merlin/egs/slt_arctic/s1 目录下创建目录experiments，在experiments目录下创建目录slt_arctic_demo，完成数据的下载与解压，并将解压后的数据分别放到slt_arctic_demo/acoustic_mode/data，slt_arctic_demo/duration_model/data目录下，分别用于声学模型和持续时间模型的训练。</p>
</div>
<div class="section" id="demo">
<h3>3 Demo语料库的训练<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h3>
<p>run_demo.sh文件会进行语音的训练以及合成。这里有许多的工程实现细节，在这里略去说明，其主要进行了如下步骤
![img](/img/image5.png)</p>
<p>其中语料库包含了文本和音频文件，文本需要首先通过前端FrontEnd处理成神经网络可接受的数据，这一步比较繁琐，不同语言也各不相同，下面会着重讲解。音频文件则通过声码器（这里使用的是STRAIGHT声码器）转换成声码器参数（包括了mfcc梅谱倒谱系数，f0基频，bap：band aperiodicity等）再参与到神经网络的训练之中。</p>
</div>
<div class="section" id="id6">
<h3>4 Demo语料库的合成<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Demo中提供了简单的合成方法，使用demo（merlin/egs/slt_arctic/s1 ）下的脚本文件：merlin_synthesis.sh即可进行特定文本的语音合成。</p>
<p>同样的，由于merlin没有自带frontend，所以其demo中直接使用了事先经过frontend转换的label文件作为输入数据来合成语音。如果想要直接输入txt文本来获得语音，需要安装FrontEnd（下文会提及）并根据merlin_synthesis.sh文件的提示用FrontEnd来转换txt文本成label文件，再进行语音合成。</p>
<p>对于英文语音合成，merlin中需要首先通过Duration模型确定音素的发音时间，然后根据声学模型合成完整的语音。</p>
</div>
<div class="section" id="id7">
<h3>5.Merlin的训练网络<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Merlin的训练网络可见 <a class="reference external" href="http://ssw9.net/papers/ssw9_PS2-13_Wu.pdf">*Merlin: An Open Source Neural Network Speech Synthesis System *</a></p>
<dl class="docutils">
<dt>Merlin一共提供了4类神经网络用于HMM模型的训练，分别是</dt>
<dd><ul class="first last simple">
<li>前馈神经网络</li>
<li>基于LSTM的RNN网络</li>
<li>双向RNN网络</li>
<li>其他变体（如blstm）</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="id8">
<h2>3.7.3 Merlin 前端<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>Merlin前端FrontEnd</p>
<p>（1）Label的分类</p>
<dl class="docutils">
<dt>在Merlin中，Label有两种类别，分别是</dt>
<dd><ul class="first last simple">
<li><a href="#id9"><span class="problematic" id="id10">**</span></a>state align**（使用HTK来生成，以发音状态为单位的label文件，一个音素由几个发音状态组成）</li>
<li><a href="#id11"><span class="problematic" id="id12">**</span></a>phoneme align**（使用Festvox来生成，以音素为单位的label文件）</li>
</ul>
</dd>
</dl>
<p>（2）txt to utt</p>
<p>文本到文本规范标注文件是非常重要的一步，这涉及自然语言处理，对于英文来说，具体工程实现可使用Festival，参见：<a class="reference external" href="http://www.cs.columbia.edu/~ecooper/tts/utt_eng.html">Creating .utt Files for English</a></p>
<p>Festival 使用了英文词典，语言规范等文件，用最新的EHMM alignment工具将txt转换成包含了文本特征（如上下文，韵律等信息）的utt文件</p>
<p>（3）utt to label</p>
<p>在获得utt的基础上，需要对每个音素的上下文信息，韵律信息进行更为细致的整理，对于英文的工程实现可参见：<a class="reference external" href="http://www.cs.columbia.edu/~ecooper/tts/labels.html">Creating Label Files for Training Data</a></p>
<p>label文件的格式请参见：<a class="reference external" href="http://www.cs.columbia.edu/~ecooper/tts/lab_format.pdf">lab_format.pdf</a></p>
<p>（4）label to training-data（HMM模型聚类）TODO</p>
<p>由于基于上下文信息的HMM模型过于庞大，有必要对HMM模型进行聚类，即使用问题集Question file.（可以参考 <a class="reference external" href="http://blog.csdn.net/quhediegooo/article/details/61202901">决策树聚类</a> ）（这个Question sets目测可以看HTS的文档来获得进一步的解释）</p>
<p>Question file 的解释：</p>
<p>The questions in the question file will be used to convert the full-context labels into binary and/or numerical features for vectorization. It is suggested to do a manual selection of the questions, as the number of questions will affect the dimensionality of the vectorized input features.</p>
<dl class="docutils">
<dt>在Merlin目录下，merlin/misc/questions目录下，有两个不同的文件，分别是：</dt>
<dd><ul class="first last simple">
<li>questions-radio_dnn_416.hed</li>
<li>questions-unilex_dnn_600.hed</li>
</ul>
</dd>
</dl>
<p>查看这两个文件，我们不难发现，questions-radio_dnn_416.hed定义了一个416维度的向量，向量各个维度上的值由label文件来确定，也即是说，从label文件上提取必要的信息，我们可以很轻易的按照定义确定Merlin训练数据training-data；同理questions-unilex_dnn_600.hed确定了一个600维度的向量，各个维度上的值依旧是由label文件加以确定。</p>
</div>
<div class="section" id="merlin-vocoder">
<h2>3.7.4 Merlin vocoder声码器<a class="headerlink" href="#merlin-vocoder" title="Permalink to this headline">¶</a></h2>
<p>Merlin中自带的vocoder工具有以下三类：Straight，World，World_v2</p>
<p>这三类工具可以在Merlin的文件目录下找到，具体的路径如下merlin/misc/scripts/vocoder</p>
<p>在介绍三类vocoder之前，首先说明几个概念：</p>
<dl class="docutils">
<dt><strong>MGC特征</strong></dt>
<dd>通过语音提取的MFCC特征由于维度太高，并不适合直接放到网络上进行训练，所以就出现了MGC特征，将提取到的MFCC特征降维（在这三个声码器中MFCC都被统一将低到60维），以这60维度的数据进行训练就形成了我们所说的MGC特征</dd>
<dt><strong>BAP特征</strong></dt>
<dd>Band Aperiodicity的缩写</dd>
<dt><strong>LF0</strong></dt>
<dd>LF0是语音的基频特征</dd>
</dl>
<p>Straight</p>
<p>音频文件通过Straight声码器产生的是：60维的MGC特征，25维的BAP特征，以及1维的LF0特征。</p>
<p>通过 STRAIGHT 合成器提取的谱参数具有独特 特征(维数较高), 所以它不能直接用于 HTS 系统中, 需要使用 SPTK 工具将其特征参数降维, 转换为 HTS 训练中可用的 mgc(Mel-generalized cepstral)参数, 即, 就是由 STRAIGHT 频谱计算得到 mgc 频谱参数, 最后 利用原 STRAIGHT 合成器进行语音合成</p>
<p>World</p>
<p>音频文件通过World声码器产生的是：60维的MGC特征，可变维度的BAP特征以及1维的LF0特征，对于16kHz采样的音频信号，BAP的维度为1，对于48kHz采样的音频信号，BAP的维度为5</p>
<p>网址为：<a class="reference external" href="https://github.com/mmorise/World">github.com/mmorise/World</a></p>
</div>
<div class="section" id="merlinlabel">
<h2>3.7.5 生成Merlin的英文label用于语音合成<a class="headerlink" href="#merlinlabel" title="Permalink to this headline">¶</a></h2>
<p>具体步骤如下参见：<a class="reference external" href="https://github.com/Jackiexiao/MTTS/blob/master/docs/mddocs/Create_your_own_label_Using_Festival.md">Create_your_own_label_Using_Festival.md</a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="vocoder.html" class="btn btn-neutral float-right" title="3.8 声码器" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="hmm_training.html" class="btn btn-neutral" title="3.6 HMM训练" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, MTTS.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>